#Convert rtl transactions to tlm xact.txt file
import re

#src=file('./rtl_src/org_v_iter_20.out','r')
src=file('./rtl_src/org_v_stub.out','r')

#target=file('sc_stub_in.txt','w')

print "# time command bytes address"
stamp=0
lastcmd="READ"
lastaddr=0
rwd=wwd=wrd=rrd=rws=wws=wrs=rrs=rwdb=wwdb=wrdb=rrdb=rw=ww=wr=rr=0;

for line in src:
    #simdata=re.search(r"#\s+\d+\s(\S+)\saddr=(\S+)\ssize=(\S+)\sdata=\*+",line)
    #for normal 
    simdata=re.search(r"#\s+(\d+)\s(\S+)\saddr=(\w+)\s(.+)",line)
    #for 6
    #simdata=re.search(r"(\d+)\sns\sMemory\s(\S+)\saddr=(\w+)\s(.+)",line)
    
    if simdata:
        nextstamp = simdata.group(1)
        cmd = simdata.group(2)
        addrtmp = simdata.group(3)
        addr = int(addrtmp,16)
        rest= simdata.group(4)
        
        lastbank=(lastaddr >> 14) & (0x3)
        lastrow =(lastaddr>>3) & (0x1fff)
        thisbank=(addr >> 14) & (0x3)
        thisrow =(addr>>3) & (0x1fff)
        
        
        if ((addr>>10)&1==1):
            rr+=1
            
            
        if (cmd == "READ"):
            if (lastcmd == "READ"):            #Rd -> Rd
                if(lastbank==thisbank):              #same bank
                    if(lastrow!=thisrow): 
                        rrd+=1                           #different row 
                    else: 
                        rrs+=1                           #same row
                else: 
                    rrdb+=1                          #different bank
                   
            elif (lastcmd=="WRITE"):           #Wr -> Rd
                if(lastbank==thisbank):              #same bank
                    if(lastrow!=thisrow):
                        wrd+=1                           #different row  
                    else: 
                        wrs+=1                           #same row                              
                else: 
                    wrdb+=1                          #different bank
                lastcmd="READ";
        elif (cmd == "WRITE"): 
            if (lastcmd == "READ"):            #Rd -> Wr
                if(lastbank==thisbank):              #same bank
                    if(lastrow!=thisrow):  
                        rwd+=1                          #different row 
                    else: 
                        rws+=1                           #same row
                else: 
                    rwdb+=1                         #different bank
                lastcmd="WRITE";       
            elif (lastcmd=="WRITE"):           #Wr -> Wr
                if(lastbank==thisbank):            #same bank
                    if(lastrow!=thisrow):
                        wwd+=1      	               #different row  
                    else:  
                        wws+=1                         #same row                              
                else: 
                    wwdb+=1                       #different bank

    
        
        #size= simdata.group(3)
        #print "%s 0x%s"%(cmd,addr)
        #time=time+10
        diff=int(nextstamp)-stamp
        print "%s(+%s) %s addr=%s %s Bank%s Row%s"%(nextstamp,diff,cmd,addrtmp,rest,thisbank,thisrow)    # 0 ns WRITE 0x4 0x10000200
        stamp=int(nextstamp)
        lastaddr=addr
        
        
    #else:
      #print " nothing"
      
print "=============================================================================%s"%rr    
print "rws rwd rwdb wwd wws wwdb wrd wrs wrdb rrd rrs rrdb"
print " %s  %s  %s  %s  %s  %s  %s  %s  %s  %s  %s  %s"%(rws,rwd,rwdb,wwd,wws,wwdb,wrd,wrs,wrdb,rrd,rrs,rrdb)
print "============================================================================="
        
src.close()
#target.close()
